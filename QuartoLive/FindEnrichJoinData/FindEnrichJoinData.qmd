---
title: "Joining Data" 
author:
  name: "Carsten Lange"
  email: "clange@cpp.edu"
  affiliation: "Cal Poly, Pomona"


format: 
  live-revealjs:
    message: false
    warning: false
    echo: true
    code-fold: true
    theme: [moon,../../CustomCL.scss]
    controls: true
    chalkboard:
      theme: whiteboard
      boardmarker-width: 2.7
    incremental: false
    scrollable: true
    

webr:
  packages:
    - tidyverse
    - rio
    - janitor
    
resources: 
  - Data

engine: knitr    
---

{{< include ../_extensions/r-wasm/live/_knitr.qmd >}}


## What Will You Learn {.scrollable .smaller}



- How to enrich data with a GIS system (*ArcGIS Online*)

## Houses Data: Omitted Variable Income

```{webr}
#| echo: false
library(tidyverse)
library(rio)
library(janitor)
DataHouses=import("Data/DataHouses.csv") |> 
           clean_names("upper_camel") |>
           select(Price, Sqft=SqftLiving, Waterfront, 
                  Cond=Condition, 
                  ZIPCode=Zipcode)
DataHouses[1,"ZIPCode"]=12345
DataHouses[2,"ZIPCode"]=12345
```

```{r}
library(tidyverse)
library(rio)
library(janitor)
DataHouses=import("Data/DataHouses.csv") |> 
           clean_names("upper_camel") |>
           select(Price, Sqft=SqftLiving, Waterfront, 
                  Cond=Condition, 
                  ZIPCode=Zipcode)
DataHouses[1,"ZIPCode"]=12345
DataHouses[2,"ZIPCode"]=12345
head(DataHouses)
```

## Regression without ZIP Income

```{webr}
ModelOLSOrg=lm(Price~Sqft+Cond+Waterfront, data=DataHouses)
summary(ModelOLSOrg)
```

## How to Find Census Data

**Census Data Tool:**

[https://data.census.gov/](https://data.census.gov/){target="_blank}

**Video:**

[https://www.lange-analytics.com/tmp/VideoFlow.html](https://www.lange-analytics.com/tmp/VideoFlow.html){target="_blank}

## How to Enrich Data with ArcGIS Online

[https://www.arcgis.com/index.html](https://www.arcgis.com/index.html){target="_blank}
            
## Data ZIP Code Tabulation Areas

```{webr}
#| echo: false
DataZipWithIncome=import("Data/KingCountyTabZipCodesTables.csv") |> 
           clean_names("upper_camel") |>
           select(ZIPTabArea=ZipCodeTabulationAreaCode, 
                  HasData, IncomeZIP=X2025MedianHouseholdIncome)
```

```{r}
DataZipWithIncome=import("Data/KingCountyTabZipCodesTables.csv") |> 
           clean_names("upper_camel") |>
           select(ZIPTabArea=ZipCodeTabulationAreaCode, 
                  HasData, IncomeZIP=X2025MedianHouseholdIncome)
print(DataZipWithIncome)
```

## Left Join

Keep all records from `left` table and only the matching ones from the `right` table.

```{webr}
DataHousesWithIncomeLeft=left_join(DataHouses, DataZipWithIncome, 
                               join_by(ZIPCode==ZIPTabArea))
print(DataHousesWithIncomeLeft)
cat("Number of Observations:", nrow(DataHousesWithIncomeLeft))
DataHousesWithIncomeLeft[!complete.cases(DataHousesWithIncomeLeft),]
```

## Right Join 
### (we could have also reversed the tables in the left join above)

Keep all records from `right` table and only the matching ones from the `left` table.

```{webr}
DataHousesWithIncomeRight=right_join(DataHouses, DataZipWithIncome, 
                               join_by(ZIPCode==ZIPTabArea))
print(DataHousesWithIncomeRight)
cat("Number of Observations:", nrow(DataHousesWithIncomeRight))
DataHousesWithIncomeRight[!complete.cases(DataHousesWithIncomeRight),]
```


## Full Join

Keep all records from `right` table and all from the `left` table.


```{webr}
DataHousesWithIncomeFull=full_join(DataHouses, DataZipWithIncome, 
                               join_by(ZIPCode==ZIPTabArea)) 

print(DataHousesWithIncomeFull)
cat("Number of Observations:", nrow(DataHousesWithIncomeFull))
DataHousesWithIncomeFull[!complete.cases(DataHousesWithIncomeFull),]
```

## Inner Join
### (most common)

Keep only records that have a match!

```{webr}
DataHousesWithIncomeInner=inner_join(DataHouses, DataZipWithIncome, 
                               join_by(ZIPCode==ZIPTabArea))

print(DataHousesWithInner)
cat("Number of Observations:", nrow(DataHousesWithIncomeInner))
DataHousesWithIncomeInner[!complete.cases(DataHousesWithIncomeInner),]
```

## Regression with ZIP Income

```{webr}
ModelOLSInc=lm(Price~Sqft+Cond+Waterfront+IncomeZIP, data=DataHousesWithIncomeInner)
summary(ModelOLSInc)
```


## Relational Multi-User SQL Databases

**Why? Some reasons:**

- effective storage and fast retrieval of data
- roll back
- simultaneous access for many users




## Creating a SQL Database
### Usually done by DBAdmin

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
drop table toys cascade constraints;
drop table bricks cascade constraints;

create table toys (
  toy_id     integer,
  toy_name   varchar2(20),
  toy_colour varchar2(10)
);

create table bricks (
  brick_id     integer,
  brick_colour varchar2(10),
  brick_shape  varchar2(10)
);

insert into toys values ( 1, 'Miss Snuggles', 'pink' ) ;
insert into toys values ( 2, 'Cuteasaurus', 'blue' ) ;
insert into toys values ( 3, 'Baby Turtle', 'green' ) ;

insert into bricks values ( 1, 'blue', 'cube' );
insert into bricks values ( 2, 'green', 'cube' );
insert into bricks values ( 3, 'blue', 'pyramid' );
insert into bricks values ( 4, 'blue', 'cube' );
insert into bricks values ( 5, 'green', 'cube' );
insert into bricks values ( 6, 'blue', 'pyramid' );

commit;
```

Tutorial:
[https://freesql.com/library/tutorials/joining-tables-databases-for-developers-TST1Qs](https://freesql.com/library/tutorials/joining-tables-databases-for-developers-TST1Qs){target="_blank"}

## Important SQL Commands: select rows with condition (like filter in R)

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT * FROM table WHERE condition
```

Example Query:
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT * FROM bricks WHERE brick_colour = 'blue'; 
```

Example Query saved as a `View`:

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
DROP View MyQuery;
CREATE View MyQuery AS SELECT * FROM bricks WHERE brick_colour = 'blue'; 
SELECT * FROM MyQuery;
```

## Important SQL Commands: delete rows with condition (like filter in R)

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
DELETE FROM table WHERE condition
```

Example Query:
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
DELETE FROM bricks WHERE brick_shape = 'pyramid'; 
```

Running `MyQuery` again (the delete from `bricks` is considered):

Example Query:
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT * FROM MyQuery; 
```

`MyQuery` is up-to-date because a `View` does not store dat. It stores *SQL* command and runs them agian when called.

## Important SQL Commands: UPDATE row entries with condition (like filter in R)

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
UPDATE table_name
SET column1 = value1,
    column2 = value2,
    ...
WHERE condition;
```

Example Query (make blue bricks red):
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
UPDATE bricks
SET brick_colour = 'red'
WHERE brick_colour = 'blue';
SELECT * FROM BRICKS
```


## Inner and Left Join

```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT columns
FROM table1
INNER JOIN table2
ON table1.column_name = table2.column_name;
```

Example Left Join Query :
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT *
FROM toys LEFT JOIN bricks
ON toys.TOY_COLOUR= bricks.BRICK_COLOUR;
```

Example Left Join Query :
```{sql}
#| code-fold: false
#| echo: true
#| eval: false
SELECT *
FROM toys INNER JOIN bricks
ON toys.TOY_COLOUR= bricks.BRICK_COLOUR;
```